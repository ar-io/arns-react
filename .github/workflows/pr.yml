name: PR deploy

on:
  pull_request:
    branches-ignore:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        step: ['lint:check', 'test', 'build']
    steps:
      - uses: actions/checkout@v3
      - run: npm ci
      - run: npm run ${{ matrix.step }}

  deploy-to-firebase:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3

      - name: Install and Build üîß
        run: |
          npm ci
          npm run build
        env:
          # FOR BUILD
          NODE_OPTIONS: --max-old-space-size=32768
          VITE_NODE_ENV: develop
          VITE_SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          VITE_SENTRY_RELEASE: ${{ github.sha }}
          VITE_SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          VITE_SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          VITE_SENTRY_DSN_PUBLIC_KEY: ${{ secrets.SENTRY_DSN_PUBLIC_KEY }}
          VITE_SENTRY_DSN_PROJECT_URI: ${{ secrets.SENTRY_DSN_PROJECT_URI }}
          VITE_SENTRY_DSN_PROJECT_ID: ${{ secrets.SENTRY_DSN_PROJECT_ID }}
          VITE_GITHUB_HASH: ${{ github.sha }}
          VITE_ARWEAVE_HOST: ${{ vars.ARWEAVE_HOST }}
          VITE_ARNS_SERVICE_API: ${{ vars.ARNS_SERVICE_API }}

      # Disribute to Firebase
      - name: Deploy üöÄ
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_CI_SERVICE_ACCOUNT }}'
          expires: 14d
